<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ”¶æ”¯å ±è¡¨</title>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div id="app">
    <div class="page-container">
      <!-- é é¢æ¨™é¡Œ -->
      <div class="page-header">
        <h2>ğŸ’° æ”¶æ”¯å ±è¡¨</h2>
        <p class="page-description">æŸ¥çœ‹ç‡Ÿæ”¶çµ±è¨ˆã€åˆ†ææ”¶æ”¯ç‹€æ³ã€ç”¢ç”Ÿè²¡å‹™å ±è¡¨</p>
      </div>

      <!-- æ™‚é–“ç¯©é¸ -->
      <div class="card mb-20">
        <div class="card-body">
          <el-form :inline="true">
            <el-form-item label="æŸ¥è©¢æ™‚é–“">
              <el-date-picker
                v-model="dateRange"
                type="monthrange"
                range-separator="è‡³"
                start-placeholder="é–‹å§‹æœˆä»½"
                end-placeholder="çµæŸæœˆä»½"
                value-format="YYYY-MM"
                @change="handleDateChange">
              </el-date-picker>
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="exportReport">
                <i class="fa-solid fa-download"></i> åŒ¯å‡ºå ±è¡¨
              </el-button>
              <el-button @click="addRecord">
                <i class="fa-solid fa-plus"></i> æ–°å¢è¨˜éŒ„
              </el-button>
            </el-form-item>
          </el-form>
        </div>
      </div>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card success">
          <div class="stat-icon">
            <i class="fa-solid fa-arrow-trend-up"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">æœ¬æœˆç‡Ÿæ”¶</div>
            <div class="stat-value">{{ reportSummary.revenue.toLocaleString() }}</div>
            <div class="stat-trend up">
              <i class="fa-solid fa-arrow-up"></i> è¼ƒä¸Šæœˆ +12%
            </div>
          </div>
        </div>
        
        <div class="stat-card danger">
          <div class="stat-icon">
            <i class="fa-solid fa-coins"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">æœ¬æœˆæˆæœ¬</div>
            <div class="stat-value">{{ reportSummary.cost.toLocaleString() }}</div>
            <div class="stat-trend down">
              <i class="fa-solid fa-arrow-down"></i> è¼ƒä¸Šæœˆ -5%
            </div>
          </div>
        </div>
        
        <div class="stat-card primary">
          <div class="stat-icon">
            <i class="fa-solid fa-chart-line"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">æœ¬æœˆæ·¨åˆ©</div>
            <div class="stat-value">{{ reportSummary.profit.toLocaleString() }}</div>
            <div class="stat-trend up">
              <i class="fa-solid fa-arrow-up"></i> è¼ƒä¸Šæœˆ +25%
            </div>
          </div>
        </div>
        
        <div class="stat-card warning">
          <div class="stat-icon">
            <i class="fa-solid fa-percent"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">åˆ©æ½¤ç‡</div>
            <div class="stat-value">{{ profitMargin }}%</div>
            <div class="stat-trend" :class="profitMargin >= 30 ? 'up' : 'down'">
              {{ profitMargin >= 30 ? 'å¥åº·' : 'éœ€æ”¹å–„' }}
            </div>
          </div>
        </div>
      </div>

      <!-- åœ–è¡¨å€åŸŸ -->
      <div class="card mb-20">
        <div class="card-header">
          <i class="fa-solid fa-chart-area"></i> ç‡Ÿæ”¶è¶¨å‹¢åœ–
        </div>
        <div class="card-body">
          <div class="chart-controls mb-15">
            <el-radio-group v-model="chartType" size="small" @change="updateChart">
              <el-radio-button label="revenue">ç‡Ÿæ”¶</el-radio-button>
              <el-radio-button label="cost">æˆæœ¬</el-radio-button>
              <el-radio-button label="profit">æ·¨åˆ©</el-radio-button>
              <el-radio-button label="all">å…¨éƒ¨</el-radio-button>
            </el-radio-group>
          </div>
          <div class="chart-wrapper">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
      </div>

      <!-- åœ“é¤…åœ– - æˆæœ¬åˆ†æ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-chart-pie"></i> æˆæœ¬çµæ§‹åˆ†æ
          </div>
          <div class="card-body">
            <div class="chart-wrapper" style="max-height: 300px;">
              <canvas id="costPieChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-ranking-star"></i> æ”¶å…¥ä¾†æºåˆ†æ
          </div>
          <div class="card-body">
            <div class="revenue-source-list">
              <div class="revenue-source-item">
                <div class="source-info">
                  <span class="source-label">ç¶­ä¿®æœå‹™</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 65%; background: #409EFF;"></div>
                  </div>
                </div>
                <span class="source-value">65%</span>
              </div>
              <div class="revenue-source-item">
                <div class="source-info">
                  <span class="source-label">é›¶ä»¶éŠ·å”®</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 25%; background: #67c23a;"></div>
                  </div>
                </div>
                <span class="source-value">25%</span>
              </div>
              <div class="revenue-source-item">
                <div class="source-info">
                  <span class="source-label">å®šæœŸä¿é¤Š</span>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: 10%; background: #e6a23c;"></div>
                  </div>
                </div>
                <span class="source-value">10%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è©³ç´°è¨˜éŒ„è¡¨æ ¼ -->
      <div class="card">
        <div class="card-header flex-between">
          <span><i class="fa-solid fa-table"></i> è©³ç´°è¨˜éŒ„</span>
          <el-input
            v-model="searchKeyword"
            placeholder="æœå°‹æ—¥æœŸ..."
            style="width: 200px;"
            clearable>
            <template #prefix>
              <i class="fa-solid fa-search"></i>
            </template>
          </el-input>
        </div>
        <div class="card-body" style="padding: 0;">
          <el-table 
            :data="filteredReportDetails" 
            border 
            stripe
            :default-sort="{ prop: 'date', order: 'descending' }">
            <el-table-column prop="date" label="æ—¥æœŸ" width="140" sortable>
              <template #default="scope">
                <i class="fa-solid fa-calendar-day"></i>
                {{ scope.row.date }}
              </template>
            </el-table-column>
            <el-table-column prop="revenue" label="æ”¶å…¥" width="140" align="right" sortable>
              <template #default="scope">
                <span style="color: #67c23a; font-weight: bold;">
                  +${{ scope.row.revenue.toLocaleString() }}
                </span>
              </template>
            </el-table-column>
            <el-table-column prop="cost" label="æˆæœ¬" width="140" align="right" sortable>
              <template #default="scope">
                <span style="color: #f56c6c; font-weight: bold;">
                  -${{ scope.row.cost.toLocaleString() }}
                </span>
              </template>
            </el-table-column>
            <el-table-column prop="profit" label="æ·¨åˆ©" width="140" align="right" sortable>
              <template #default="scope">
                <span :style="{ color: scope.row.profit >= 0 ? '#409EFF' : '#f56c6c', fontWeight: 'bold' }">
                  ${{ scope.row.profit.toLocaleString() }}
                </span>
              </template>
            </el-table-column>
            <el-table-column prop="margin" label="åˆ©æ½¤ç‡" width="120" align="center">
              <template #default="scope">
                <el-tag :type="getMarginType(scope.row.margin)" size="small">
                  {{ scope.row.margin }}%
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="note" label="å‚™è¨»" min-width="200"></el-table-column>
            <el-table-column label="æ“ä½œ" width="140" align="center" fixed="right">
              <template #default="scope">
                <el-button size="small" @click="editRecord(scope.row)">
                  <i class="fa-solid fa-edit"></i>
                </el-button>
                <el-button size="small" type="danger" @click="deleteRecord(scope.row)">
                  <i class="fa-solid fa-trash"></i>
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
      </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯è¨˜éŒ„å°è©±æ¡† -->
    <el-dialog 
      v-model="showRecordDialog" 
      :title="dialogTitle"
      width="500px">
      <el-form :model="currentRecord" label-width="90px">
        <el-form-item label="æ—¥æœŸ" required>
          <el-date-picker
            v-model="currentRecord.date"
            type="date"
            placeholder="é¸æ“‡æ—¥æœŸ"
            value-format="YYYY/MM/DD"
            style="width: 100%;">
          </el-date-picker>
        </el-form-item>
        <el-form-item label="æ”¶å…¥" required>
          <el-input-number 
            v-model="currentRecord.revenue" 
            :min="0"
            :step="100"
            style="width: 100%;">
          </el-input-number>
        </el-form-item>
        <el-form-item label="æˆæœ¬" required>
          <el-input-number 
            v-model="currentRecord.cost" 
            :min="0"
            :step="100"
            style="width: 100%;">
          </el-input-number>
        </el-form-item>
        <el-form-item label="å‚™è¨»">
          <el-input 
            v-model="currentRecord.note"
            type="textarea"
            :rows="3"
            placeholder="è¼¸å…¥å‚™è¨»...">
          </el-input>
        </el-form-item>
        <el-form-item label="è¨ˆç®—çµæœ">
          <div class="calc-result">
            <div>æ·¨åˆ©ï¼š<strong style="color: #409EFF;">${{ calculateProfit().toLocaleString() }}</strong></div>
            <div>åˆ©æ½¤ç‡ï¼š<strong style="color: #67c23a;">{{ calculateMargin() }}%</strong></div>
          </div>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showRecordDialog = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveRecord">
          <i class="fa-solid fa-check"></i> ç¢ºèª
        </el-button>
      </template>
    </el-dialog>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const { createApp, ref, computed, nextTick, watch } = Vue

    createApp({
      setup() {
        const reportDetails = ref([
          { id: 1, date: '2025/10/01', revenue: 5000, cost: 3000, profit: 2000, margin: 40, note: 'é€±ä¸€ç‡Ÿæ¥­' },
          { id: 2, date: '2025/10/03', revenue: 8000, cost: 4500, profit: 3500, margin: 44, note: 'é€±ä¸‰æ¥­ç¸¾ä½³' },
          { id: 3, date: '2025/10/05', revenue: 12000, cost: 7000, profit: 5000, margin: 42, note: 'é€±æœ«æ—ºå­£' },
          { id: 4, date: '2025/10/07', revenue: 15000, cost: 8500, profit: 6500, margin: 43, note: 'å¤§å‹ç¶­ä¿®æ¡ˆ' },
          { id: 5, date: '2025/10/10', revenue: 9000, cost: 5000, profit: 4000, margin: 44, note: '' },
          { id: 6, date: '2025/10/12', revenue: 11000, cost: 6200, profit: 4800, margin: 44, note: '' },
          { id: 7, date: '2025/10/15', revenue: 13500, cost: 7800, profit: 5700, margin: 42, note: 'æœˆä¸­é«˜å³°' },
        ])

        const dateRange = ref(['2025-10', '2025-10'])
        const searchKeyword = ref('')
        const chartType = ref('all')
        const showRecordDialog = ref(false)
        const isEditing = ref(false)
        const currentRecord = ref({
          date: '',
          revenue: 0,
          cost: 0,
          note: ''
        })

        // çµ±è¨ˆæ‘˜è¦
        const reportSummary = computed(() => {
          const revenue = reportDetails.value.reduce((sum, r) => sum + r.revenue, 0)
          const cost = reportDetails.value.reduce((sum, r) => sum + r.cost, 0)
          const profit = revenue - cost
          return { revenue, cost, profit }
        })

        // åˆ©æ½¤ç‡
        const profitMargin = computed(() => {
          if (reportSummary.value.revenue === 0) return 0
          return Math.round((reportSummary.value.profit / reportSummary.value.revenue) * 100)
        })

        // ç¯©é¸å¾Œçš„å ±è¡¨
        const filteredReportDetails = computed(() => {
          if (!searchKeyword.value) return reportDetails.value
          return reportDetails.value.filter(r => 
            r.date.includes(searchKeyword.value) || r.note.includes(searchKeyword.value)
          )
        })

        // å°è©±æ¡†æ¨™é¡Œ
        const dialogTitle = computed(() => {
          return isEditing.value ? 'ç·¨è¼¯è¨˜éŒ„' : 'æ–°å¢è¨˜éŒ„'
        })

        // Chart.js å¯¦ä¾‹
        const dailyChartInstance = ref(null)
        const costPieChartInstance = ref(null)

        // åˆå§‹åŒ–æŠ˜ç·šåœ–
        const initLineChart = () => {
          nextTick(() => {
            const ctx = document.getElementById('dailyChart')
            if (!ctx) return
            if (dailyChartInstance.value) dailyChartInstance.value.destroy()

            const datasets = []
            
            if (chartType.value === 'revenue' || chartType.value === 'all') {
              datasets.push({
                label: 'ç‡Ÿæ”¶',
                data: reportDetails.value.map(r => r.revenue),
                borderColor: '#67c23a',
                backgroundColor: 'rgba(103, 194, 58, 0.1)',
                tension: 0.4,
                fill: true
              })
            }
            
            if (chartType.value === 'cost' || chartType.value === 'all') {
              datasets.push({
                label: 'æˆæœ¬',
                data: reportDetails.value.map(r => r.cost),
                borderColor: '#f56c6c',
                backgroundColor: 'rgba(245, 108, 108, 0.1)',
                tension: 0.4,
                fill: true
              })
            }
            
            if (chartType.value === 'profit' || chartType.value === 'all') {
              datasets.push({
                label: 'æ·¨åˆ©',
                data: reportDetails.value.map(r => r.profit),
                borderColor: '#409EFF',
                backgroundColor: 'rgba(64, 158, 255, 0.1)',
                tension: 0.4,
                fill: true
              })
            }

            dailyChartInstance.value = new Chart(ctx, {
              type: 'line',
              data: {
                labels: reportDetails.value.map(r => r.date.slice(5)),
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: { 
                    display: true,
                    position: 'top'
                  },
                  tooltip: { 
                    mode: 'index', 
                    intersect: false 
                  }
                },
                scales: {
                  y: { 
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return '$' + value.toLocaleString()
                      }
                    }
                  }
                }
              }
            })
          })
        }

        // åˆå§‹åŒ–åœ“é¤…åœ–
        const initPieChart = () => {
          nextTick(() => {
            const ctx = document.getElementById('costPieChart')
            if (!ctx) return
            if (costPieChartInstance.value) costPieChartInstance.value.destroy()

            costPieChartInstance.value = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ['äººäº‹æˆæœ¬', 'é›¶ä»¶æˆæœ¬', 'ç§Ÿé‡‘æ°´é›»', 'å…¶ä»–'],
                datasets: [{
                  data: [45, 35, 15, 5],
                  backgroundColor: [
                    '#409EFF',
                    '#67c23a',
                    '#e6a23c',
                    '#f56c6c'
                  ]
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            })
          })
        }

        // åˆå§‹åŒ–åœ–è¡¨
        initLineChart()
        initPieChart()

        // æ›´æ–°åœ–è¡¨
        const updateChart = () => {
          initLineChart()
        }

        // åˆ©æ½¤ç‡é¡å‹
        const getMarginType = (margin) => {
          if (margin >= 40) return 'success'
          if (margin >= 30) return 'warning'
          return 'danger'
        }

        // æ—¥æœŸè®Šæ›´
        const handleDateChange = (value) => {
          console.log('æ—¥æœŸç¯„åœ:', value)
          ElementPlus.ElMessage.info('æ—¥æœŸç¯©é¸åŠŸèƒ½é–‹ç™¼ä¸­')
        }

        // æ–°å¢è¨˜éŒ„
        const addRecord = () => {
          isEditing.value = false
          const today = new Date()
          currentRecord.value = {
            date: `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`,
            revenue: 0,
            cost: 0,
            note: ''
          }
          showRecordDialog.value = true
        }

        // ç·¨è¼¯è¨˜éŒ„
        const editRecord = (record) => {
          isEditing.value = true
          currentRecord.value = { ...record }
          showRecordDialog.value = true
        }

        // åˆªé™¤è¨˜éŒ„
        const deleteRecord = (record) => {
          ElementPlus.ElMessageBox.confirm(
            `ç¢ºå®šè¦åˆªé™¤ ${record.date} çš„è¨˜éŒ„å—ï¼Ÿ`,
            'ç¢ºèªåˆªé™¤',
            {
              confirmButtonText: 'ç¢ºå®š',
              cancelButtonText: 'å–æ¶ˆ',
              type: 'warning',
            }
          ).then(() => {
            const index = reportDetails.value.findIndex(r => r.id === record.id)
            if (index !== -1) {
              reportDetails.value.splice(index, 1)
              ElementPlus.ElMessage.success('å·²åˆªé™¤è¨˜éŒ„')
              updateChart()
            }
          }).catch(() => {})
        }

        // è¨ˆç®—æ·¨åˆ©
        const calculateProfit = () => {
          return (currentRecord.value.revenue || 0) - (currentRecord.value.cost || 0)
        }

        // è¨ˆç®—åˆ©æ½¤ç‡
        const calculateMargin = () => {
          const revenue = currentRecord.value.revenue || 0
          const profit = calculateProfit()
          if (revenue === 0) return 0
          return Math.round((profit / revenue) * 100)
        }

        // å„²å­˜è¨˜éŒ„
        const saveRecord = () => {
          const r = currentRecord.value
          if (!r.date || r.revenue === 0) {
            ElementPlus.ElMessage.warning('è«‹å¡«å¯«å®Œæ•´è³‡æ–™')
            return
          }

          if (isEditing.value) {
            const index = reportDetails.value.findIndex(item => item.id === r.id)
            if (index !== -1) {
              reportDetails.value[index] = {
                ...r,
                profit: calculateProfit(),
                margin: calculateMargin()
              }
              ElementPlus.ElMessage.success('æ›´æ–°æˆåŠŸ')
            }
          } else {
            const newId = reportDetails.value.length > 0
              ? Math.max(...reportDetails.value.map(r => r.id)) + 1
              : 1
            
            reportDetails.value.push({
              id: newId,
              ...r,
              profit: calculateProfit(),
              margin: calculateMargin()
            })
            ElementPlus.ElMessage.success('æ–°å¢æˆåŠŸ')
          }

          showRecordDialog.value = false
          updateChart()
        }

        // åŒ¯å‡ºå ±è¡¨
        const exportReport = () => {
          ElementPlus.ElMessage.info('åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­')
        }

        return {
          reportDetails,
          filteredReportDetails,
          reportSummary,
          profitMargin,
          dateRange,
          searchKeyword,
          chartType,
          showRecordDialog,
          dialogTitle,
          currentRecord,
          updateChart,
          getMarginType,
          handleDateChange,
          addRecord,
          editRecord,
          deleteRecord,
          calculateProfit,
          calculateMargin,
          saveRecord,
          exportReport
        }
      }
    }).use(ElementPlus).mount('#app')
  </script>

  <style>
/* åœ–è¡¨æ§åˆ¶ */
.chart-controls {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.chart-wrapper {
  position: relative;
  height: 350px;
  padding: 10px;
}

.chart-wrapper canvas {
  max-height: 100%;
}

/* æ”¶å…¥ä¾†æºåˆ—è¡¨ */
.revenue-source-list {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 10px 0;
}

.revenue-source-item {
  display: flex;
  align-items: center;
  gap: 16px;
}

.source-info {
  flex: 1;
}

.source-label {
  font-size: 14px;
  color: #606266;
  margin-bottom: 8px;
  display: block;
}

.source-value {
  font-size: 18px;
  font-weight: bold;
  color: #409EFF;
  min-width: 60px;
  text-align: right;
}

/* è¨ˆç®—çµæœ */
.calc-result {
  background: #f5f7fa;
  padding: 16px;
  border-radius: 6px;
  display: flex;
  justify-content: space-around;
  font-size: 15px;
}

/* éŸ¿æ‡‰å¼ */
@media (max-width: 768px) {
  .chart-wrapper {
    height: 250px;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .revenue-source-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .source-value {
    align-self: flex-end;
  }
}
  </style>
</body>
</html>